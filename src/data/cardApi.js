import { buildErrorResponse, buildErrorResponseFromCatch } from "../helpers/utils";
import { MESSAGES } from "../shared/constants/messages";
import { fetchWithSignatureHeaders } from "../shared/utils/apiFetch";
/**
 * Saves or updates a customer's card information.
 *
 * This function sends a POST request to save or update the card information for a customer.
 *
 * @param signatures
 * @param {string} baseUrl - The base URL of the API.
 * @param {string} customerToken - The customer's authentication token.
 * @param {string} secureToken - Token generated by secure-token endpoint.
 * @param {string | number} businessId - The business ID.
 * @param {import("../../types").ISaveCardSkyflowRequest} data - The card information to be saved.
 * @returns {Promise<import("../../types").ISaveCardResponse>} The saved card data.
 *
 * @throws {import("../../types").IApiError} Throws an error object if the save/update operation fails.
 */
export async function saveCustomerCard(
  signatures,
  baseUrl,
  customerToken,
  secureToken,
  businessId,
  data,
) {
  try {
    const url = `${baseUrl}/api/v1/business/${businessId}/cards/`;
    const response = await fetchWithSignatureHeaders(
      url,
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${secureToken}`,
          "User-Token": customerToken,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      },
      signatures,
      "customer",
    );

    if (response.ok) return await response.json();

    const res_json = await response.json();
    if (response.status === 409) {
      if ((res_json.error = "Card number already exists.")) {
        return {
          code: 200,
          body: res_json,
          name: "",
          message: res_json.error,
        };
      }
    }
    throw await buildErrorResponse(response, res_json);
  } catch (error) {
    throw buildErrorResponseFromCatch(error);
  }
}

/**
 * Removes a customer's card.
 * @param signatures
 * @param {string} baseUrl - The base URL of the  API.
 * @param {string} customerToken - The customer's authentication token.
 * @param {string} secureToken - Token generated by secure-token endpoint.
 * @param {string} skyflowId - The Skyflow ID of the card to be removed.
 * @param {string} businessId - The business ID.
 * @returns {Promise<string>} The result of the card removal operation.
 *
 * @throws {import("../../types").IApiError} Throws an error object if the operation fails.
 */
export async function removeCustomerCard(
  signatures,
  baseUrl,
  customerToken,
  secureToken,
  skyflowId = "",
  businessId,
) {
  try {
    const url = `${baseUrl}/api/v1/business/${businessId}/cards/${skyflowId}`;

    const response = await fetchWithSignatureHeaders(
      url,
      {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${secureToken}`,
          "Content-Type": "application/json",
          "User-Token": customerToken,
        },
      },
      signatures,
      "customer",
    );

    if (response.status === 204) return MESSAGES.cardSaved;
    if (response.ok && "json" in response) return await response.json();
    const res_json = await response.json();

    throw await buildErrorResponse(response, res_json);
  } catch (error) {
    throw buildErrorResponseFromCatch(error);
  }
}

/**
 * Fetches a customer's saved cards.
 * @param signatures
 * @param {string} baseUrl - The base URL of the  API.
 * @param {string} customerToken - The customer's authentication token.
 * @param {string} secureToken - Token generated by secure-token endpoint.
 * @param {string} businessId - The business ID.
 * @param {AbortSignal} signal - The abort signal to cancel the request.
 * @returns {Promise<import("../../types").ICustomerCardsResponse>} The customer's saved cards.
 *
 * @throws {import("../../types").IApiError} Throws an error object if the operation fails.
 */
export async function fetchCustomerCards(
  signatures,
  baseUrl,
  customerToken,
  secureToken,
  businessId,
  signal = null,
) {
  try {
    const url = `${baseUrl}/api/v1/business/${businessId}/cards/`;
    const response = await fetchWithSignatureHeaders(
      url,
      {
        method: "GET",
        headers: {
          Authorization: `Bearer ${secureToken}`,
          "User-Token": customerToken,
        },
        signal,
      },
      signatures,
      "customer",
    );
    if (response.ok) return await response.json();
    if (response.status === 401) {
      return {
        code: 401,
        body: {},
        name: "",
        message: "Unauthorized",
      };
    }

    const res_json = await response.json();

    throw await buildErrorResponse(response, res_json, MESSAGES.getCardsError);
  } catch (error) {
    console.log("error", error);
    throw buildErrorResponseFromCatch(error, MESSAGES.getCardsError);
  }
}
